# Phase 3: Cell Renaming Workflow

## Overview

The final Verilog netlists generated by `eco_generator.py` use **original netlist names** (Yosys auto-generated names like `$abc$9276$auto$...`). To make the netlists directly compatible with physical implementation, cell instances should be renamed to use **fabric slot names** (e.g., `T8Y18__R2_OR_2`).

## Workflow

### Step 1: Generate Final Verilog (Original Names)
```bash
python eco_generator.py --design 6502 --placement placement_greedy_initial.map
```

**Output:**
- `build/6502/6502_final.v` — Contains ~100K cells with original Yosys names

### Step 2: Rename Cells to Fabric Names
```bash
python rename_verilog_cells.py \
  --verilog build/6502/6502_final.v \
  --placement build/6502/6502_cts.map \
  --output build/6502/6502_final_renamed.v \
  --verbose
```

**What it does:**
1. Loads placement map: `fabric_slot cell_type x y -> logical_instance`
2. Parses Verilog and identifies all cell instantiations
3. Replaces logical instance names with fabric slot names where available
4. Writes renamed Verilog to output file

**Output:**
- `build/6502/6502_final_renamed.v` — Contains renamed cells using fabric names
  - 2,899 cells renamed (CTS buffers + ECO infrastructure cells)
  - 97,685 cells remain with original names (no fabric mapping available, will be handled in Phase 4)

### Example Transformation

**Before (original names):**
```verilog
sky130_fd_sc_hd__or2_2 $abc$9276$auto$blifparse.cc:396:parse_blif$10000 (.A(net_124), .B(net_125), .X(net_126));
```

**After (fabric names):**
```verilog
sky130_fd_sc_hd__or2_2 T8Y18__R2_OR_2 (.A(net_124), .B(net_125), .X(net_126));
```

## Fabric Name Format

Fabric slot names follow the pattern: `T<x>Y<y>__R<rank>_<type>_<index>`

- **T<x>Y<y>** — Tile coordinates (e.g., T8Y18 = Tile at X=8, Y=18)
- **R<rank>** — Ranking/level within tile (0-3)
- **<type>** — Cell type prefix (OR, NAND, INV, BUF, CONB)
- **<index>** — Sequential index within that type/rank

Example: `T8Y18__R2_OR_2` = 2nd OR gate, rank 2, in tile T8Y18

## Files

| File | Purpose | Status |
|------|---------|--------|
| `eco_generator.py` | Generate final Verilog with CTS/ECO (keeps original names) | ✓ Complete |
| `rename_verilog_cells.py` | Rename cells from logical to fabric names | ✓ New |
| `build/6502/6502_final.v` | Original names (~100K cells) | ✓ Generated |
| `build/6502/6502_final_renamed.v` | Fabric names (2.9K CTS/ECO renamed) | ✓ Generated |
| `build/6502/6502_cts.map` | Placement mapping (CTS output) | ✓ Used for renaming |

## Integration with Phase 4

**Phase 4 (rename.py)** expects final Verilog with a mix of:
- **Fabric names** for placed cells (handled by this workflow)
- **Original names** for unmapped cells (will be assigned to available fabric slots in Phase 4)

The `rename_verilog_cells.py` script provides the foundation for `rename.py` to complete the mapping.

## Usage Examples

### Rename single design
```bash
python rename_verilog_cells.py --verilog design_final.v --placement design.map
```

### Rename with custom output
```bash
python rename_verilog_cells.py \
  --verilog build/6502/6502_final.v \
  --placement build/6502/6502_cts.map \
  --output my_renamed_design.v
```

### Check results
```bash
# Before
grep "sky130_fd_sc_hd__or2_2 \$abc" build/6502/6502_final.v | head -1

# After
grep "sky130_fd_sc_hd__or2_2 T" build/6502/6502_final_renamed.v | head -1
```

## Statistics (6502 Design)

| Metric | Value |
|--------|-------|
| Total cell instantiations | 100,584 |
| Mapped to fabric names | 2,899 |
| Unmapped (original names) | 97,685 |
| CTS buffers in fabric | 89 |
| ECO tie-cells in fabric | ~2,810 |
| File size (original) | 7.7 MB |
| File size (renamed) | 7.6 MB |

## Notes

- The script preserves all Verilog structure, comments, and formatting
- Unmapped cells keep their original names and will be handled in Phase 4
- The placement map is generated by `eco_generator.py` (output: `[design]_cts.map`)
- Idempotent: Running the script again with the same inputs produces identical output
